(function(){if(window.__HEADER_INTERACTIONS_INITIALIZED__){return;}window.__HEADER_INTERACTIONS_INITIALIZED__=true;const headerStates=new Map();let globalListenersReady=false;function updateBadgeDisplay(badgeEl,unread){if(!badgeEl)return;const count=Math.max(0,Number.isFinite(unread)? unread:0);badgeEl.textContent=count;badgeEl.style.display=count>0 ? "inline-flex":"none";}function closeMenus(header,state){if(!state){return;}if(state.mainNav){state.mainNav.classList.remove("open");}if(state.userMenu){state.userMenu.classList.remove("open");}if(state.notifMenu){state.notifMenu.classList.remove("open");}if(state.notifBtn){state.notifBtn.setAttribute("aria-expanded","false");}}function handleDocumentClick(event){const target=event.target instanceof Element ? event.target:null;if(!target){return;}headerStates.forEach((state,header)=>{if(!header.contains(target)){closeMenus(header,state);}});}function handleResize(){if(window.innerWidth>768){headerStates.forEach((state,header)=>{closeMenus(header,state);});}}function ensureGlobalListeners(){if(globalListenersReady){return;}document.addEventListener("click",handleDocumentClick);window.addEventListener("resize",handleResize);globalListenersReady=true;}function setupHeader(header){if(!header || headerStates.has(header)){return;}const mobileBtn=header.querySelector("#mobileMenuBtn");const mainNav=header.querySelector("#mainNav");const userBtn=header.querySelector("#userBtn");const userMenu=header.querySelector("#userMenu");const notifBtn=header.querySelector("#notifBtn");const notifMenu=header.querySelector("#notifMenu");const notifBadge=header.querySelector("#notifBadge");const state={mainNav,userMenu,notifBtn,notifMenu,notifBadge,notifLoaded:false,notifLoading:false,badgeLoading:false,badgePollId:null};headerStates.set(header,state);if(mobileBtn && mainNav){mobileBtn.addEventListener("click",(event)=>{event.preventDefault();event.stopPropagation();const isOpen=mainNav.classList.toggle("open");if(isOpen && userMenu){userMenu.classList.remove("open");}});}if(userBtn && userMenu){userBtn.addEventListener("click",(event)=>{event.preventDefault();event.stopPropagation();const isOpen=userMenu.classList.toggle("open");if(isOpen && mainNav){mainNav.classList.remove("open");}if(state.notifMenu){state.notifMenu.classList.remove("open");}});}if(notifBtn && notifMenu){notifBtn.addEventListener("click",(event)=>{event.preventDefault();event.stopPropagation();const isOpen=notifMenu.classList.toggle("open");notifBtn.setAttribute("aria-expanded",isOpen ? "true":"false");if(isOpen){if(mainNav)mainNav.classList.remove("open");if(userMenu)userMenu.classList.remove("open");loadNotifications(state);}});}if(state.notifBadge){startNotifBadgePolling(state);}}function renderNotifications(state,data,markedAsRead=false){const menu=state.notifMenu;const badge=state.notifBadge;if(!menu)return;menu.innerHTML="";const makeEmpty=(text)=>{const div=document.createElement("div");div.className="notif-empty";div.textContent=text;return div;};const list=(data && Array.isArray(data.notifications))? data.notifications:[];if(!list.length){menu.appendChild(makeEmpty("Nessuna notifica"));}else{const handleDelete=(notif,itemEl)=>{if(!notif || !notif.id || !itemEl)return;if(itemEl.dataset.confirming==="1")return;itemEl.dataset.confirming="1";const confirmBar=document.createElement("div");confirmBar.className="notif-confirm";confirmBar.style.display="flex";confirmBar.style.alignItems="center";confirmBar.style.gap="8px";confirmBar.style.marginTop="8px";const msg=document.createElement("span");msg.textContent="Eliminare questa notifica?";msg.style.flex="1";msg.style.fontSize="12px";msg.style.color="#15293e";msg.style.fontWeight="600";const cancelBtn=document.createElement("button");cancelBtn.type="button";cancelBtn.textContent="Annulla";cancelBtn.style.padding="6px 10px";cancelBtn.style.borderRadius="6px";cancelBtn.style.border="1px solid #c7d1e6";cancelBtn.style.background="#f4f6fb";cancelBtn.style.color="#15293e";cancelBtn.style.cursor="pointer";cancelBtn.addEventListener("click",(ev)=>{ev.stopPropagation();itemEl.dataset.confirming="";confirmBar.remove();});const okBtn=document.createElement("button");okBtn.type="button";okBtn.textContent="Elimina";okBtn.style.padding="6px 10px";okBtn.style.borderRadius="6px";okBtn.style.border="1px solid #b00000";okBtn.style.background="#d80000";okBtn.style.color="#ffffff";okBtn.style.cursor="pointer";okBtn.addEventListener("click",(ev)=>{ev.stopPropagation();fetch("/api/notifications.php",{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({delete_id:notif.id,type:notif.type || "generic"})}).then(res=>res.ok ? res.json():Promise.reject(res)).then(resp=>{if(resp && resp.success){if(itemEl && itemEl.parentNode)itemEl.parentNode.removeChild(itemEl);const remaining=menu.querySelectorAll(".notif-item").length;if(remaining===0){menu.appendChild(makeEmpty("Nessuna notifica"));}if(badge){const current=parseInt(badge.textContent || "0",10)|| 0;const nextVal=Math.max(0,current-(notif.read ? 0:1));updateBadgeDisplay(badge,nextVal);}}}).catch(()=>{}).finally(()=>{itemEl.dataset.confirming="";});});confirmBar.appendChild(msg);confirmBar.appendChild(cancelBtn);confirmBar.appendChild(okBtn);itemEl.appendChild(confirmBar);};list.forEach((n)=>{const item=document.createElement("div");item.className="notif-item";if(n.link){item.style.cursor="pointer";item.addEventListener("click",()=>{window.location.href=n.link;});}const title=document.createElement("div");title.className="notif-title";title.textContent=n.title || "Notifica";const text=document.createElement("div");text.className="notif-text";text.textContent=n.text || "";const meta=document.createElement("div");meta.className="notif-meta";meta.textContent=n.time || "";const actions=document.createElement("div");actions.className="notif-actions";const delBtn=document.createElement("button");delBtn.type="button";delBtn.className="notif-delete";delBtn.textContent="Elimina";delBtn.style.marginLeft="auto";delBtn.style.background="#d80000";delBtn.style.border="1px solid #b00000";delBtn.style.color="#ffffff";delBtn.style.cursor="pointer";delBtn.style.fontWeight="700";delBtn.style.borderRadius="6px";delBtn.style.padding="6px 10px";delBtn.style.fontSize="12px";delBtn.style.transition="all 0.15s ease";delBtn.addEventListener("mouseover",()=>{delBtn.style.background="#b00000";delBtn.style.borderColor="#900000";});delBtn.addEventListener("mouseout",()=>{delBtn.style.background="#d80000";delBtn.style.borderColor="#b00000";});delBtn.addEventListener("click",(ev)=>{ev.stopPropagation();handleDelete(n,item);});actions.appendChild(delBtn);item.appendChild(title);if(n.text)item.appendChild(text);if(n.time)item.appendChild(meta);item.appendChild(actions);menu.appendChild(item);});}if(badge){const unread=(data && typeof data.unread==="number")? data.unread:0;updateBadgeDisplay(badge,markedAsRead ? 0:unread);}}function fetchBadgeCount(state){if(!state || state.badgeLoading || !state.notifBadge)return;state.badgeLoading=true;fetch("/api/notifications.php",{credentials:"include"}).then((res)=>res.ok ? res.json():Promise.reject(res)).then((data)=>{const unread=(data && typeof data.unread==="number")? data.unread:0;updateBadgeDisplay(state.notifBadge,unread);}).catch(()=>{}).finally(()=>{state.badgeLoading=false;});}function startNotifBadgePolling(state){if(!state || state.badgePollId || !state.notifBadge)return;fetchBadgeCount(state);state.badgePollId=window.setInterval(()=>fetchBadgeCount(state),60000);}function loadNotifications(state){if(!state || state.notifLoading)return;state.notifLoading=true;if(state.notifMenu){state.notifMenu.innerHTML='<div class="notif-empty">Caricamento...</div>';}fetch("/api/notifications.php?mark_read=1",{credentials:"include"}).then((res)=>res.ok ? res.json():Promise.reject(res)).then((data)=>{renderNotifications(state,data ||{},true);}).catch(()=>{if(state.notifMenu){state.notifMenu.innerHTML='<div class="notif-empty">Errore nel caricamento</div>';}}).finally(()=>{state.notifLoading=false;});}function resolveScope(root){if(root && typeof root.querySelectorAll==="function"){return root;}return document;}function publishAuthState(headers){const isAuth=Array.from(headers ||[]).some((header)=>header && header.getAttribute("data-auth")==="1");document.documentElement.setAttribute("data-user-auth",isAuth ? "1":"0");if(document.body){document.body.setAttribute("data-user-auth",isAuth ? "1":"0");}window.__TOS_IS_AUTH=isAuth;}function initHeaderInteractions(root){const scope=resolveScope(root);const headers=scope.querySelectorAll(".site-header");if(!headers.length){publishAuthState([]);return;}publishAuthState(headers);headers.forEach(setupHeader);ensureGlobalListeners();}function loadPrivacyScript(){if(window.__TOS_CONSENT_LOADER__){return;}window.__TOS_CONSENT_LOADER__=true;const script=document.createElement("script");script.src="/includi/privacy-consent.js?v=20251206";script.defer=true;document.head.appendChild(script);}const socialState={observer:null,requested:false};function formatFollowerCount(value){if(!Number.isFinite(value))return '--';if(value>=1_000_000)return(value / 1_000_000).toFixed(1).replace(/\.0$/,'')+'M';if(value>=1_000)return(value / 1_000).toFixed(1).replace(/\.0$/,'')+'k';return value.toLocaleString('it-IT');}function renderSocialCounts(data){const badges=document.querySelectorAll("[data-social-count]");if(!badges.length)return;const counts=data ||{};badges.forEach((badge)=>{const key=badge.getAttribute("data-social-count");const entry=counts[key]||{};const value=entry && Number.isFinite(entry.count)? entry.count:null;badge.textContent=value !==null ? formatFollowerCount(value):'--';badge.dataset.status=value !==null ? "ok":"error";if(entry && entry.error){badge.title=entry.error;}});}function fetchSocialCounts(){socialState.requested=true;fetch("/api/social_followers.php",{credentials:"same-origin"}).then((res)=>(res.ok ? res.json():Promise.reject(res))).then((payload)=>{renderSocialCounts((payload && payload.counts)||{});}).catch(()=>{renderSocialCounts({});});}function tryInitSocialCounters(root){const scope=root || document;if(!scope || typeof scope.querySelectorAll !=="function"){return false;}const badges=scope.querySelectorAll("[data-social-count]");if(!badges.length){return false;}badges.forEach((badge)=>{badge.dataset.status="loading";badge.textContent="--";});if(!socialState.requested){fetchSocialCounts();}return true;}function initSocialCounters(){if(socialState.observer || socialState.requested){return;}const footerSlot=document.getElementById("footer-container");const scope=footerSlot || document;if(tryInitSocialCounters(scope)){if(footerSlot){socialState.observer=new MutationObserver(()=>{if(tryInitSocialCounters(footerSlot)){socialState.observer.disconnect();socialState.observer=null;}});socialState.observer.observe(footerSlot,{childList:true,subtree:true});}return;}socialState.observer=new MutationObserver(()=>{if(tryInitSocialCounters(document)&& socialState.observer){socialState.observer.disconnect();socialState.observer=null;}});socialState.observer.observe(document.body || document.documentElement || document,{childList:true,subtree:true});}window.initHeaderInteractions=initHeaderInteractions;window.initSocialCounters=initSocialCounters;loadPrivacyScript();if(document.readyState !=="loading"){initHeaderInteractions(document);initSocialCounters();}else{document.addEventListener("DOMContentLoaded",()=>{initHeaderInteractions(document);initSocialCounters();});}})();